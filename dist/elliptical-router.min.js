!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=e(require("elliptical-utils"),require("elliptical-mvc"),require("elliptical-event"),require("elliptical-url")):"function"==typeof define&&define.amd?define(["elliptical-utils","elliptical-mvc","elliptical-event","elliptical-url"],e):(t.elliptical.Router=e(t.elliptical.utils,t.elliptical,t.elliptical.Event,t.elliptical.url),t.returnExports=t.elliptical.Router)}(this,function(t,e,o,n){var i=e.Class,r=t._,a=i.extend({events:{request:"elliptical.onDocumentRequest",click:"touchclick",orientation:"onOrientationChange"},backButtonSelector:'[data-role="back"]',on:function(){var t=this;$(window).on(this.events.request,function(e,o){t.forward(o)}),$(document).on(this.events.click,this.backButtonSelector,function(){l.history()}),$(window).on(this.events.orientation,function(e,o){o.method="get",t.forward(e,o)})},off:function(){var t=this;$(window).off(this.events.request,function(e,o){t.forward(o)}),$(document).off(this.events.click,this.backButtonSelector,function(){l.history()}),$(window).off(this.events.orientation,function(e,o){o.method="get",t.forward(e,o)})},reset:function(){this.off(),this.on()},forward:function(t){var e=t.route,o={},n=t.method;l.location(e,n,o)}},{}),s=i.extend({stateObject:null,poppedDelay:700,pushHistory:!1,push:function(){if(this.pushHistory){var t=this.stateObject,e="";t.route=c.hashify(t.route),window.history.pushState(t,e,t.route)}},pop:function(t){var e=this,o=$.support.touch||!1;if(t.originalEvent.state){var n=t.originalEvent.state.route,i=t.originalEvent.state.params,r=t.originalEvent.state.method;this.pushHistory=!1,o?setTimeout(function(){u.location(n,r,i)},e.poppedDelay):u.location(n,r,i)}},start:function(){var t=this,e=c.path(),o=c.search,n="get",i={route:e,params:o,method:n};this.stateObject=i,this.pushHistory=!0,u.location(i.route,"get",o),$(window).on("popstate",function(e){t.pop(e)})},end:function(){var t=this;this.stateObject=null,this.pushHistory=!1,$(window).off("popstate",function(e){t.pop(e)})}},{}),u=i.extend({dispatchEvent:"elliptical.onRouteDispatch",add:function(t,e,o){if(this.verify(e,t)){var n={route:e,method:t,handle:o};if(l.routes.push(n),l.debug){var i="route: "+e+" has been added. Method: "+t;l.enabled?console.log(i):l.messageQueue.push(i)}}},remove:function(t,e){var o=-1;l.routes.forEach(function(n,i){var r=n.route,a=n.method;t===r&&e===a&&(o=i)}),o>-1&&(l.routes.splice(o,1),l.debug&&console.log("route: "+t+" has been removed"))},verify:function(t,e){var o=!0;return l.routes.every(function(n){var i=n.route,r=n.method;t===i&&e===r&&(o=!1)}),o},decodeUrl:function(t){return decodeURIComponent(t.replace(/\+/g,"%20"))},deserialize:function(t){for(var e=t.split("&"),o=[],n=0;n<e.length;n++){var i=this.decodeUrl(e[n]).split("="),r=i[0],a=i[1],s={name:r,value:a};o.push(s)}return o},location:function(t,e,n){if(t=c.deHashify(t),s.push(),!this.dispatch(t,e,n)){var i=[];i.push(this.error);var r={route:t,handlers:i};o.emit(this.dispatchEvent,r)}},dispatch:function(t,e){var i=this,r=this.dispatchEvent,a=!1,s=l.routes;return t=t.toLowerCase(),s.forEach(function(s){var u={},l={},h=s.route;h=h.toLowerCase();var d=c.toPath(t),f=n.match(h),p=f.parse(d);if(null!=p&&s.method.toLowerCase()===e.toLowerCase()&&!a){"get"!=e.toLowerCase()&&(u=n.body(p)),l=n.query(t);var v=[],g=i.next(p,u,l,d);v.push(g);for(var m=s.handle,y=0;y<m.length;y++)v.push(m[y]);var b={route:d,handlers:v};o.emit(r,b),a=!0}}),a},next:function(t,e,o,n){return function(i,r,a){r.statusCode=200,i.params=t,i.query=o,i.route=n,i.body=e,a()}},error:function(t,e,o){e.statusCode=404;o()}},{}),c=i.extend({"@class":"Location",hashify:function(e){var o=l.virtualRoot,n="/"!==o;if(l.hashTag&&n){0!==e.indexOf(o)&&(e=o+e);var i=o.length;"#"!==e.charAt(i+1)&&(e=t.stringInsertAt(e,i,"/#"))}else l.hashTag?"#"!==e.charAt(1)&&(e="/#"+e):n&&0!==e.indexOf(o)&&(e=o+e);return e},deHashify:function(t){var e=l.virtualRoot;return"/"!==e&&0===t.indexOf(e)&&(t=t.replace(e,"")),l.hashTag&&"#"===t.charAt(1)&&(t=t.substring(2)),t},hashRoot:function(t){return l.hashTag&&"#"===t.slice(-1)?t+="/":t},path:function(){var t,e=window.elliptical.$hashTag,o=window.elliptical.$virtualRoot;return e?(t=location.hash,"#"===t.charAt(0)&&(t=t.substring(1)),""===t&&(t="/"),t=this.toPath(t)):(t=location.pathname,"/"!==o&&0===t.indexOf(o)&&(t=t.replace(o,""))),t},toPath:function(t){var e=t.split("?");return e[0]},redirect:function(t){location.href=t},reload:function(){location.reload()},url:n,href:location.href,host:location.host,hostname:location.hostname,origin:location.origin,protocol:location.protocol,port:location.port,search:location.search},{}),l=i.extend({"@class":"Router",validMethods:["get","post","put","delete"],enabled:!1,debug:!0,callbacks:[],routes:[],virtualRoot:"/",hashTag:!1,messageQueue:[],get:function(t,e){this.parseMethod("get",t,e)},post:function(t,e){this.parseMethod("post",t,e)},put:function(t,e){this.parseMethod("put",t,e)},"delete":function(t,e){this.parseMethod("delete",t,e)},parseMethod:function(t,e){if(!r.contains(this.validMethods,t))return!1;var o=[];"string"!=typeof e&&(e="/");for(var n=Array.prototype.slice.call(arguments,0),i=0;i<n.length;i++)"function"==typeof n[i]&&o.push(n[i]);n.length<1?console.log('error adding route: "'+e+'".  A route must have at least one handler function.'):u.add(t,e,o)},remove:function(t,e){return this.enabled?void u.remove(t,e):!1},removeAll:function(){var t=this;return this.enabled?void this.routes.forEach(function(e){t.remove(e.route,e.method)}):!1},location:function(t,e,o,i){if(!this.enabled)return!1;"undefined"==typeof o&&(o={}),t=n.sanitize(t),t=c.hashRoot(t);var r={route:t,params:o,method:e};s.stateObject=r,s.pushHistory=!0,"undefined"!=typeof i?setTimeout(function(){u.location(t,e,o)},i):u.location(t,e,o)},start:function(){if(this.enabled)return!1;if(this.enabled=!0,s.start(),a.on(),this.debug){var t="Router has started in debug mode";console.log(t),this.messageQueue.forEach(function(t){console.log(t)}),this.messageQueue.length=0}},pause:function(){this.enabled=!1,a.off()},resume:function(){this.enabled=!1,a.on()},history:function(t,e){"undefined"!=typeof e?setTimeout(function(){"undefined"==typeof t?window.history.back():window.history.go(t)},e):"undefined"==typeof t?window.history.back():window.history.go(t)},end:function(){this.enabled=!1,this.routes=[],s.end(),a.off()},$provider:function(t,e){"string"==typeof t?u.dispatchEvent=e:"undefined"!=typeof t&&(o=t,"string"==typeof e&&(u.dispatchEvent=e))},configure:function(t){t.request&&(a.events.request=t.request),t.orientation&&(a.events.orientation=t.orientation),t.click&&(a.events.click=t.click),t.backButtonSelector&&(a.backButtonSelector=t.backButtonSelector),t.dispatchEvent&&(u.dispatchEvent=t.dispatchEvent),a.reset()}},{});return l.Location=c,l});